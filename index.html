<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»™é˜¿ä½³çš„ä¸€æ¯å…¨ç³–</title>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. å…¨å±€è®¾ç½® --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #ffe6fa;
            font-family: 'Noto Sans SC', sans-serif;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; user-select: none;
            transition: background 2s ease; /* èƒŒæ™¯æ¸å˜è¿‡æ¸¡ */
        }
        
        #phone-screen {
            width: 100%; max-width: 414px; height: 100%; max-height: 896px;
            background: #fff; position: relative; overflow: hidden;
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.2);
            display: flex; flex-direction: column;
            border-radius: 0;
        }
        @media (min-width: 500px) {
            #phone-screen { height: 90vh; border-radius: 30px; border: 8px solid #333; }
        }

        /* --- 2. é”å±ç•Œé¢ --- */
        #lock-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white;
            transition: transform 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .notification {
            background: rgba(255,255,255,0.95); color: #333;
            padding: 20px 30px; border-radius: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center; cursor: pointer; animation: bounce 2s infinite;
            max-width: 80%;
        }
        .icon-warn { font-size: 2rem; margin-bottom: 10px; display: block; }

        /* --- 3. èŠå¤©ç•Œé¢ --- */
        #chat-header {
            height: 60px; background: #fff; border-bottom: 1px solid #f0f0f0;
            display: flex; align-items: center; padding: 0 20px; font-weight: bold;
            color: #333; font-family: 'ZCOOL KuaiLe', cursive; font-size: 1.2rem;
            justify-content: center; position: relative; z-index: 2;
        }
        #chat-header::before { content: '<'; position: absolute; left: 20px; color: #ccc; }
        
        #chat-container {
            flex: 1; overflow-y: auto; padding: 20px;
            background: #f5f5f5; display: flex; flex-direction: column;
            scroll-behavior: smooth; z-index: 1;
        }
        
        .message {
            max-width: 80%; margin-bottom: 15px; padding: 12px 18px;
            border-radius: 20px; position: relative; font-size: 1rem;
            line-height: 1.5; animation: popIn 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transform-origin: left bottom;
        }
        .message.sent { align-self: flex-end; background: #95ec69; color: #000; border-bottom-right-radius: 4px; transform-origin: right bottom; }
        .message.received { align-self: flex-start; background: #fff; color: #000; border-bottom-left-radius: 4px; }
        
        .typing-indicator {
            padding: 10px 15px; background: #fff; border-radius: 20px;
            border-bottom-left-radius: 4px; align-self: flex-start; margin-bottom: 15px;
            display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .typing-dot {
            height: 6px; width: 6px; border-radius: 50%; background: #bbb;
            display: inline-block; margin: 0 2px; animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        .voice-bubble {
            background: #ffbdd0; color: #fff; cursor: pointer;
            display: flex; align-items: center; justify-content: space-between;
            min-width: 140px; font-weight: bold;
        }
        .voice-icon { width: 24px; height: 24px; fill: #fff; animation: wave 1s infinite linear paused;}
        .voice-bubble.playing .voice-icon { animation-play-state: running; }

        /* --- 4. è¡¨ç™½å¡ç‰‡ (Music Player Mode) --- */
        #confession-card {
            position: absolute; bottom: -100%; left: 0; width: 100%;
            background: white; border-top-left-radius: 35px; border-top-right-radius: 35px;
            padding: 30px 25px; box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
            transition: bottom 0.8s cubic-bezier(0.165, 0.84, 0.44, 1), height 0.8s ease;
            z-index: 50; box-sizing: border-box;
            max-height: 80%; overflow: hidden; /* æ”¹ä¸ºhiddenï¼Œé˜²æ­¢åŒæ»šåŠ¨æ¡ */
            display: flex; flex-direction: column; align-items: center;
        }
        
        /* åˆå§‹æ–‡å­—æ¨¡å¼ */
        #text-content-wrapper {
            width: 100%; overflow-y: auto; max-height: 100%;
            transition: opacity 0.5s;
        }
        #confession-card h2 { color: #ff88a7; font-family: 'ZCOOL KuaiLe'; margin-top: 0; text-align: center;}
        .card-content {
            font-family: 'Noto Sans SC', sans-serif; color: #555;
            line-height: 1.8; font-size: 1rem; white-space: pre-wrap;
            text-align: left; margin-bottom: 20px;
        }

        /* ğŸµ éŸ³ä¹æ’­æ”¾å™¨æ¨¡å¼ (éšè—çŠ¶æ€) */
        #music-player-ui {
            display: none; width: 100%; height: 100%;
            flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 1s;
        }
        
        /* æ—‹è½¬çš„å”±ç‰‡ */
        .vinyl-record {
            width: 200px; height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, #fff 10%, #333 11%, #111 40%, #333 41%, #111 60%, #333 61%, #111 100%);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center;
            animation: spin 8s linear infinite;
            margin-bottom: 30px; border: 5px solid #fff;
        }
        .vinyl-inner {
            width: 80px; height: 80px; border-radius: 50%;
            background: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Felix') no-repeat center/cover; /* è¿™é‡Œå¯ä»¥ç”¨ä¸ªå¤´åƒAPIæˆ–è€…çº¯è‰² */
            background-color: #ff9a9e;
            border: 2px solid #fff;
        }
        
        /* å¤§æ­Œè¯ */
        #big-lyric {
            font-size: 1.2rem; color: #ff88a7; font-family: 'ZCOOL KuaiLe';
            text-align: center; min-height: 60px; line-height: 1.5;
            font-weight: bold; padding: 0 20px;
            text-shadow: 1px 1px 0 #fff;
            transform: scale(1); transition: transform 0.2s;
        }
        
        .btn-group { margin-top: 20px; display: flex; justify-content: center; gap: 20px; position: relative; height: 60px; width: 100%;}
        .btn { border: none; padding: 12px 30px; border-radius: 50px; font-size: 1.1rem; font-family: 'ZCOOL KuaiLe'; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.2s;}
        .btn-yes { background: linear-gradient(to right, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); color: white; z-index: 5;}
        .btn-yes:active { transform: scale(0.95); }
        .btn-no { background: #eee; color: #888; position: absolute; right: 20px; z-index: 5;}

        /* é¡¶éƒ¨å°æ­Œè¯æ  (å‰æœŸä½¿ç”¨) */
        #lyric-bar {
            position: absolute; top: 65px; left: 0; width: 100%;
            text-align: center; color: #ff88a7; font-size: 0.9rem; font-weight: bold;
            pointer-events: none; transition: opacity 0.3s; opacity: 0;
            text-shadow: 1px 1px 0 #fff;
        }

        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @keyframes wave { 0% { transform: translateX(0); } 50% { transform: translateX(3px); } 100% { transform: translateX(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse-bg { 0% { background-color: #ffe6fa; } 50% { background-color: #e6f9ff; } 100% { background-color: #ffe6fa; } }
        
        .emoji-float { position: fixed; font-size: 1.5rem; animation: floatUp linear forwards; z-index: 999; pointer-events: none; }
        @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg); opacity: 0.8;} 100% { transform: translateY(-80vh) rotate(20deg); opacity: 0;} }
        
        /* æ´¾å¯¹æ¨¡å¼æ ·å¼ */
        body.party-mode {
            animation: pulse-bg 5s infinite;
        }
    </style>
</head>
<body>

    <audio id="bgm" loop>
        <source src="æ±ªè‹æ³·&èŠ±æ¾¤é¦™èœ - æœ‰ç‚¹ç”œ(Live).mp3" type="audio/mpeg">
    </audio>

    <div id="phone-screen">
        <div id="lock-screen" onclick="unlockPhone()">
            <div class="notification">
                <span class="icon-warn">ğŸ¬</span>
                <h3>ç”œåº¦è¶…æ ‡æé†’</h3>
                <p>æ£€æµ‹åˆ° [é˜¿ä½³çš„ä¸“å±å°è·Ÿç­]<br>å‘æ¥ä¸€ä»½å…¨ç³–å»å†°çš„æ¶ˆæ¯</p>
                <p style="font-size: 0.8rem; margin-top: 15px; color: #aaa;">ğŸ‘† ç‚¹å‡»è§£é”æŸ¥æ”¶</p>
            </div>
        </div>

        <div id="chat-header">é˜¿ä½³å®å®</div>
        <div id="lyric-bar">â™ª æ­£åœ¨ç¼“å†²ç”œç”œçš„æ‹çˆ±...</div>
        <div id="chat-container">
            <div style="text-align: center; color: #ccc; font-size: 0.8rem; margin-top: 10px; margin-bottom: 20px;">æ˜¨å¤© 23:59</div>
        </div>

        <div id="confession-card">
            <div id="text-content-wrapper">
                <h2>âœ¨ æ‹çˆ±ç”³è¯·ä¹¦ âœ¨</h2>
                <div class="card-content" id="card-text"></div>
                <div class="btn-group">
                    <button class="btn btn-yes" onclick="agree()">å¥½å‘€ï¼Œå‡†äº†ï¼</button>
                    <button class="btn btn-no" onmouseover="runAway(this)" onclick="runAway(this)">å“’å’©</button>
                </div>
            </div>

            <div id="music-player-ui">
                <div class="vinyl-record">
                    <div class="vinyl-inner"></div>
                </div>
                <div id="big-lyric">â™ª çˆ±æƒ…æœ‰ç‚¹ç”œ â™ª</div>
                <div style="margin-top: 20px; color: #aaa; font-size: 0.8rem;">æ­£åœ¨æ’­æ”¾: é˜¿ä½³çš„ä¸“å±å…¨ç³–BGM</div>
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒº =================
        const CONFIG = {
            chatSequence: [
                { type: 'typing_self', duration: 1000 },
                { type: 'text_temp', text: "ä½ æœ‰æ²¡æœ‰åœ°å›¾ï¼Ÿæˆ‘åœ¨ä½ çœ¼ç›é‡Œè¿·è·¯äº†...", duration: 1500 }, 
                { type: 'typing_self', duration: 800 },
                { type: 'text_sent', text: "é˜¿ä½³ï¼Œæˆ‘ä»Šå¤©å»ä¹°å¥¶èŒ¶äº†ã€‚" },
                { type: 'typing_self', duration: 1200 },
                { type: 'text_sent', text: "è™½ç„¶ç‚¹äº†ä¸‰åˆ†ç³–..." },
                { type: 'text_temp', text: "ä½†æˆ‘è¿˜æ˜¯å¥½æƒ³ä½ å•Šï¼", duration: 1200 },
                { type: 'text_sent', text: "ä½†åªè¦ä¸€æƒ³åˆ°ä½ ã€‚" },
                { type: 'text_sent', text: "æˆ‘å°±è§‰å¾—ç”œåº¦ç›´æ¥çˆ†è¡¨äº†ï¼ğŸ¯" },
                { type: 'typing_self', duration: 1000 },
                { type: 'text_sent', text: "å¬å¬è¿™é¦–æ­Œï¼Œåƒä¸åƒæˆ‘ä»¬ï¼ŸğŸ‘‡" },
                { type: 'voice_sent', text: "ç‚¹å‡»æ”¶å¬ã€Šæœ‰ç‚¹ç”œã€‹", duration: "03:52" }
            ],

            finalLetter: `To æˆ‘æœ€å–œæ¬¢çš„é˜¿ä½³ï¼š

åˆ«äººéƒ½è¯´â€œæœ‰ç‚¹ç”œâ€ï¼Œ
ä½†æˆ‘è§‰å¾—é‡åˆ°ä½ ä¹‹åï¼Œ
æˆ‘çš„ç”Ÿæ´»ç®€ç›´æ˜¯â€œå…¨ç³–å»å†°â€ï¼

ä½ æ˜¯ä¹æœˆçš„æƒŠå–œï¼Œ
æ˜¯æˆ‘è€³æœºé‡Œå¾ªç¯æ’­æ”¾çš„å•æ›²ï¼Œ
æ˜¯æˆ‘æ¯å¤©çå¼€çœ¼å°±æƒ³è”ç³»çš„äººã€‚

æ‰€ä»¥...
èƒ½ä¸èƒ½ç»™æˆ‘ä¸€ä¸ªæœºä¼šï¼Ÿ
è®©æˆ‘æ‰¿åŒ…ä½ ä»¥åçš„å¥¶èŒ¶ã€å¤œå®µã€
è¿˜æœ‰æ‰€æœ‰çš„å¼€å¿ƒå’Œä¸å¼€å¿ƒã€‚

ç”³è¯·äººï¼šç“œç“œ~
æ—¥æœŸï¼šçˆ±ä½ çš„æ¯ä¸€å¤©`,
            
            // æ­Œè¯ä¿æŒä¸å˜
            lrcContent: `
[00:00.001]æœ‰ç‚¹ç”œ (Live) - æ±ªè‹æ³·/èŠ±æ¾¤é¦™èœ (ã¯ãªã–ã‚ ã‹ãª)
[00:04.279]è¯ï¼šæ±ªè‹æ³·
[00:04.887]æ›²ï¼šæ±ªè‹æ³·
[00:05.47]ç¼–æ›²ï¼šé‡‘è‹¥æ™¨
[00:06.198]åŸå”±ï¼šæ±ªè‹æ³·/BY2
[00:20.029]æ±ªï¼š
[00:22.543]æ‘˜ä¸€é¢—è‹¹æœ
[00:24.334]ç­‰ä½ ä»é—¨å‰ç»è¿‡
[00:27.008]é€åˆ°ä½ çš„æ‰‹ä¸­å¸®ä½ è§£æ¸´
[00:30.424]èŠ±æ¾¤é¦™èœï¼š
[00:31.039]åƒå¤å¤©çš„å¯ä¹
[00:33.455]åƒå†¬å¤©çš„å¯å¯
[00:36.288]ä½ æ˜¯å¯¹çš„æ—¶é—´å¯¹çš„è§’è‰²
[00:39.08]æ±ªï¼š
[00:40.635]å·²ç»çº¦å®šè¿‡
[00:42.531]ä¸€èµ·è¿‡ä¸‹ä¸ªå‘¨æœ«
[00:45.333]ä½ çš„å°å°æƒ…ç»ªå¯¹æˆ‘æ¥è¯´
[00:48.039]èŠ±æ¾¤é¦™èœï¼š
[00:49.204]æˆ‘ä¹Ÿä¸çŸ¥ä¸ºä½•
[00:51.711]ä¼¤å£è¿˜æ²¡æ„ˆåˆ
[00:54.465]ä½ å°±è¿™æ ·é—¯è¿›æˆ‘çš„å¿ƒçª
[00:58.93]æ˜¯ä½ è®©æˆ‘çœ‹è§å¹²æ¯æ²™æ¼ å¼€å‡ºèŠ±ä¸€æœµ
[01:03.11]æ±ªï¼š
[01:03.32]æ˜¯ä½ è®©æˆ‘æƒ³è¦æ¯å¤©ä¸ºä½ å†™ä¸€é¦–æƒ…æ­Œ
[01:07.468]èŠ±æ¾¤é¦™èœï¼š
[01:08.121]ç”¨æœ€æµªæ¼«çš„å‰¯æ­Œ
[01:09.863]æ±ªï¼š
[01:10.055]ä½ ä¹Ÿè½»è½»çš„é™„å’Œ
[01:12.114]èŠ±æ¾¤é¦™èœï¼š
[01:12.943]çœ¼ç¥åšå®šç€æˆ‘ä»¬çš„é€‰æ‹©
[01:17.195]æ˜¯ä½ è®©æˆ‘çš„ä¸–ç•Œä»é‚£åˆ»å˜æˆç²‰çº¢è‰²
[01:21.329]æ±ªï¼š
[01:21.579]æ˜¯ä½ è®©æˆ‘çš„ç”Ÿæ´»ä»æ­¤éƒ½åªè¦ä½ é…åˆ
[01:25.861]èŠ±æ¾¤é¦™èœï¼š
[01:26.432]çˆ±è¦ç²¾å¿ƒæ¥é›•åˆ»
[01:28.076996]æ±ªï¼š
[01:28.332]æˆ‘æ˜¯ç±³å¼€æœ—åŸºç½—
[01:30.506]åˆï¼š
[01:31.012]ç”¨å¿ƒåˆ»ç”»æœ€å¹¸ç¦çš„é£æ ¼
[01:34.561005]èŠ±æ¾¤é¦™èœï¼š
[01:36.033005]ç”¨æ—¶é—´ å»æ€å¿µ çˆ±æƒ…æœ‰ç‚¹ç”œ
[01:45.033005]è¿™å¿ƒæ„¿ ä¸ä¼šå˜ çˆ±æƒ…æœ‰ç‚¹ç”œ
[01:53.168]æ±ªï¼š
[01:53.987]å·²ç»çº¦å®šè¿‡
[01:55.712006]ä¸€èµ·è¿‡ä¸‹ä¸ªå‘¨æœ«
[01:58.441]ä½ çš„å°å°æƒ…ç»ªå¯¹æˆ‘æ¥è¯´
[02:01.06]èŠ±æ¾¤é¦™èœï¼š
[02:02.102]æˆ‘ä¹Ÿä¸çŸ¥ä¸ºä½•
[02:04.722]ä¼¤å£è¿˜æ²¡æ„ˆåˆ
[02:07.659]ä½ å°±è¿™æ ·é—¯è¿›æˆ‘çš„å¿ƒçª
[02:12.038]æ˜¯ä½ è®©æˆ‘çœ‹è§å¹²æ¯æ²™æ¼ å¼€å‡ºèŠ±ä¸€æœµ
[02:16.276]æ±ªï¼š
[02:16.489]æ˜¯ä½ è®©æˆ‘æƒ³è¦æ¯å¤©ä¸ºä½ å†™ä¸€é¦–æƒ…æ­Œ
[02:20.746]èŠ±æ¾¤é¦™èœï¼š
[02:21.4]ç”¨æœ€æµªæ¼«çš„å‰¯æ­Œ
[02:23.113]æ±ªï¼š
[02:23.337]ä½ ä¹Ÿè½»è½»çš„é™„å’Œ
[02:25.262]åˆï¼š
[02:25.837]çœ¼ç¥åšå®šç€æˆ‘ä»¬çš„é€‰æ‹©
[02:29.0]èŠ±æ¾¤é¦™èœï¼š
[02:30.263]æ˜¯ä½ è®©æˆ‘çš„ä¸–ç•Œä»é‚£åˆ»å˜æˆç²‰çº¢è‰²
[02:34.56601]æ±ªï¼š
[02:34.83301]æ˜¯ä½ è®©æˆ‘çš„ç”Ÿæ´»ä»æ­¤éƒ½åªè¦ä½ é…åˆ
[02:39.055]èŠ±æ¾¤é¦™èœï¼š
[02:39.799]çˆ±è¦ç²¾å¿ƒæ¥é›•åˆ»
[02:41.47299]æ±ªï¼š
[02:41.65]æˆ‘æ˜¯ç±³å¼€æœ—åŸºç½—
[02:43.604]åˆï¼š
[02:44.123]ç”¨å¿ƒåˆ»ç”»æœ€å¹¸ç¦çš„é£æ ¼
[02:47.49701]èŠ±æ¾¤é¦™èœï¼š
[02:48.804]æ˜¯ä½ è®©æˆ‘çœ‹è§å¹²æ¯æ²™æ¼ å¼€å‡ºèŠ±ä¸€æœµ
[02:52.93]æ±ªï¼š
[02:53.111]æ˜¯ä½ è®©æˆ‘æƒ³è¦æ¯å¤©ä¸ºä½ å†™ä¸€é¦–æƒ…æ­Œ
[02:57.354]èŠ±æ¾¤é¦™èœï¼š
[02:58.013]ç”¨æœ€æµªæ¼«çš„å‰¯æ­Œ
[02:59.643]æ±ªï¼š
[02:59.85901]ä½ ä¹Ÿè½»è½»çš„é™„å’Œ
[03:01.986]åˆï¼š
[03:02.537]çœ¼ç¥åšå®šç€æˆ‘ä»¬çš„é€‰æ‹©
[03:05.618]èŠ±æ¾¤é¦™èœï¼š
[03:06.755]æ˜¯ä½ è®©æˆ‘çš„ä¸–ç•Œä»é‚£åˆ»å˜æˆç²‰çº¢è‰²
[03:11.069]æ±ªï¼š
[03:11.263]æ˜¯ä½ è®©æˆ‘çš„ç”Ÿæ´»ä»æ­¤éƒ½åªè¦ä½ é…åˆ
[03:15.627]èŠ±æ¾¤é¦™èœï¼š
[03:16.317]çˆ±è¦ç²¾å¿ƒæ¥é›•åˆ»
[03:17.949]æ±ªï¼š
[03:18.177]æˆ‘æ˜¯ç±³å¼€æœ—åŸºç½—
[03:20.434]åˆï¼š
[03:20.706]ç”¨å¿ƒåˆ»ç”»æœ€å¹¸ç¦çš„é£æ ¼
[03:25.369]ç”¨å¿ƒåˆ»ç”»æœ€å¹¸ç¦çš„é£æ ¼
`
        };

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const actx = new AudioContext();

        function playTone(freq, type, duration, vol=0.1) {
            if(actx.state === 'suspended') actx.resume();
            const osc = actx.createOscillator();
            const gain = actx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, actx.currentTime);
            gain.gain.setValueAtTime(vol, actx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, actx.currentTime + duration);
            osc.connect(gain);
            gain.connect(actx.destination);
            osc.start();
            osc.stop(actx.currentTime + duration);
        }
        function playTypingSound() { playTone(800 + Math.random()*200, 'sine', 0.05, 0.05); }
        function playSentSound() {
            if(actx.state === 'suspended') actx.resume();
            const osc = actx.createOscillator();
            const gain = actx.createGain();
            osc.frequency.setValueAtTime(400, actx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, actx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.1, actx.currentTime);
            gain.gain.linearRampToValueAtTime(0, actx.currentTime + 0.3);
            osc.connect(gain); gain.connect(actx.destination); osc.start(); osc.stop(actx.currentTime + 0.3);
        }
        function playWinSound() {
            [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => { setTimeout(() => { playTone(freq, 'triangle', 0.6, 0.2); }, i * 100); });
        }

        const chatContainer = document.getElementById('chat-container');
        const audio = document.getElementById('bgm');
        const lyricBar = document.getElementById('lyric-bar');
        const bigLyric = document.getElementById('big-lyric');
        let isLocked = true;
        let isPartyMode = false; // æ–°å¢çŠ¶æ€
        let typingInterval;

        function unlockPhone() {
            if (!isLocked) return;
            isLocked = false;
            if(actx.state === 'suspended') actx.resume();
            document.getElementById('lock-screen').style.transform = 'translateY(-100%)';
            audio.load(); 
            playTone(1200, 'sine', 0.1, 0.1);
            setTimeout(startChatSimulation, 800);
        }

        async function startChatSimulation() {
            for (let step of CONFIG.chatSequence) { await handleChatStep(step); }
        }

        function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        async function handleChatStep(step) {
            switch (step.type) {
                case 'typing_self':
                    const typingBubble = document.createElement('div');
                    typingBubble.className = 'typing-indicator';
                    typingBubble.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
                    typingBubble.style.display = 'inline-block';
                    chatContainer.appendChild(typingBubble);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    typingInterval = setInterval(playTypingSound, 150); 
                    await wait(step.duration);
                    clearInterval(typingInterval);
                    typingBubble.remove();
                    break;
                case 'text_temp':
                    playSentSound();
                    const tempMsg = addMessage('sent', step.text);
                    await wait(step.duration);
                    tempMsg.style.transition = 'opacity 0.5s'; tempMsg.style.opacity = '0.5';
                    setTimeout(() => {
                        playTone(300, 'square', 0.1, 0.05);
                        tempMsg.innerText = '"å°ç¬¨è›‹" æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯';
                        tempMsg.style.fontSize = '0.8rem'; tempMsg.style.background = 'transparent'; tempMsg.style.color = '#aaa';
                        tempMsg.style.padding = '5px 0'; tempMsg.style.textAlign = 'center'; tempMsg.style.boxShadow = 'none';
                    }, 500);
                    await wait(800);
                    break;
                case 'text_sent':
                    playSentSound(); addMessage('sent', step.text); await wait(1000); break;
                case 'voice_sent':
                    playSentSound(); addVoiceMessage(step.text, step.duration); break;
            }
        }

        function addMessage(type, htmlContent) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}`;
            msgDiv.innerHTML = htmlContent;
            chatContainer.appendChild(msgDiv); chatContainer.scrollTop = chatContainer.scrollHeight; return msgDiv;
        }

        function addVoiceMessage(text, duration) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message sent voice-bubble`;
            msgDiv.innerHTML = `<svg class="voice-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg><span style="margin-left: 10px;">${text}</span><span style="font-size: 0.8rem; margin-left: 10px; opacity: 0.8;">${duration}</span>`;
            msgDiv.onclick = function() {
                if (audio.paused) {
                    audio.play(); this.classList.add('playing'); this.style.background = "#ff9a9e"; 
                    showConfessionCard(); lyricBar.style.opacity = 1;
                } else {
                    audio.pause(); this.classList.remove('playing'); this.style.background = "#ffbdd0";
                }
            };
            chatContainer.appendChild(msgDiv); chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showConfessionCard() {
            const card = document.getElementById('confession-card');
            const cardText = document.getElementById('card-text');
            let i = 0; cardText.innerHTML = ""; card.style.bottom = "0"; 
            function typeCard() {
                if (i < CONFIG.finalLetter.length) {
                    cardText.innerHTML += CONFIG.finalLetter.charAt(i) === '\n' ? '<br>' : CONFIG.finalLetter.charAt(i);
                    i++; playTypingSound(); setTimeout(typeCard, 50);
                }
            }
            setTimeout(typeCard, 600);
        }

        function runAway(btn) {
            const x = (Math.random() * 200 - 100); const y = (Math.random() * 200 - 100); 
            btn.style.transform = `translate(${x}px, ${y}px)`;
            btn.innerText = ["å“å‘€æ»‘èµ°äº†", "ç‚¹ä¸åˆ°", "ç•¥ç•¥ç•¥", "å“’å’©"][Math.floor(Math.random()*4)];
            playTone(300, 'sawtooth', 0.1, 0.1);
        }

        function agree() {
            playWinSound();
            isPartyMode = true; // å¼€å¯æ´¾å¯¹æ¨¡å¼æ ‡è®°

            // 1. ç•Œé¢åˆ‡æ¢ï¼šéšè—æ–‡æœ¬ï¼Œæ˜¾ç¤ºéŸ³ä¹æ’­æ”¾å™¨
            const textWrapper = document.getElementById('text-content-wrapper');
            const musicPlayer = document.getElementById('music-player-ui');
            const card = document.getElementById('confession-card');

            textWrapper.style.opacity = 0;
            setTimeout(() => {
                textWrapper.style.display = 'none';
                musicPlayer.style.display = 'flex';
                // å¼ºåˆ¶é‡ç»˜
                void musicPlayer.offsetWidth; 
                musicPlayer.style.opacity = 1;
                // å¡ç‰‡é«˜åº¦è‡ªé€‚åº”å……æ»¡
                card.style.height = "60%";
                card.style.bottom = "10%";
            }, 500);

            // 2. å¼€å¯èƒŒæ™¯å¾‹åŠ¨
            document.body.classList.add('party-mode');

            // 3. æŒç»­çš„æ³¡æ³¡é›¨
            setInterval(createFloatEmoji, 800); 
        }

        function createFloatEmoji() {
            const emoji = document.createElement('div');
            emoji.className = 'emoji-float';
            emoji.innerHTML = ['ğŸ­', 'ğŸ¬', 'ğŸ©', 'â¤', 'ğŸ˜', 'âœ¨', 'ğŸµ'][Math.floor(Math.random() * 7)];
            emoji.style.left = Math.random() * 80 + 10 + 'vw';
            emoji.style.animationDuration = Math.random() * 3 + 4 + 's';
            document.body.appendChild(emoji);
            setTimeout(() => emoji.remove(), 7000);
        }

        const lyrics = parseLrc(CONFIG.lrcContent);
        audio.addEventListener('timeupdate', () => {
            const ct = audio.currentTime;
            for (let i = lyrics.length - 1; i >= 0; i--) {
                if (ct >= lyrics[i].time) {
                    const text = lyrics[i].text;
                    // å¦‚æœè¿›å…¥äº†æ´¾å¯¹æ¨¡å¼ï¼Œæ›´æ–°å¤§æ­Œè¯ï¼Œå¹¶ä¸”ç»™ä¸€ä¸ªè·³åŠ¨ç‰¹æ•ˆ
                    if (isPartyMode) {
                        if (bigLyric.innerText !== text) {
                            bigLyric.style.transform = "scale(1.1)";
                            bigLyric.style.color = "#ff5e78";
                            bigLyric.innerText = text;
                            setTimeout(() => {
                                bigLyric.style.transform = "scale(1)";
                                bigLyric.style.color = "#ff88a7";
                            }, 150);
                        }
                    } else {
                        lyricBar.innerText = "â™ª " + text + " â™ª";
                    }
                    break;
                }
            }
        });
        function parseLrc(lrc) {
            const lines = lrc.split('\n'); const result = [];
            for (let line of lines) {
                const match = line.match(/\[(\d+):(\d+)(\.\d+)?\](.*)/);
                if (match) result.push({ time: parseInt(match[1])*60 + parseInt(match[2]) + (match[3]?parseFloat(match[3]):0), text: match[4].trim() });
            }
            return result;
        }
    </script>
</body>
</html>
